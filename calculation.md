# Справочник по Логике Расчета Урона

Этот документ предоставляет полный обзор всех формул и логики расчета урона в приложении "Калькулятор Урона". Он может быть использован как справочник для воссоздания этой логики в других проектах.

## Оглавление

1. [Базовые Константы](#базовые-константы)
2. [Расчет Атаки](#расчет-атаки)
3. [Расчет Процента Ледяного Взрыва](#расчет-процента-ледяного-взрыва)
4. [Расчеты Урона](#расчеты-урона)
5. [Расчет Урона Нефрита (3 взрыва)](#расчет-урона-нефрита-3-взрыва)
6. [Специализация Урона по Боссам и Монстрам](#специализация-урона-по-боссам-и-монстрам)
7. [Расчет Бонусов Нефрита](#расчет-бонусов-нефрита)
8. [Полный Поток Расчетов](#полный-поток-расчетов)

## Базовые Константы

Это основные константы, используемые во всех расчетах:

```python
# Базовое значение атаки
BASE_ATTACK = 140

# Коэффициенты урона ледяного взрыва
EXPLOSION_COEF = 4.06
FLOWER_EXPLOSION_COEF = 4.97

# Мультипликаторы взрывов нефрита
JADE_FIRST_BLAST_MULTIPLIER = 0.55
JADE_OTHER_BLAST_MULTIPLIER = 0.569

# Значения по умолчанию
DEFAULT_CONSCIOUSNESS = 1120
DEFAULT_HERO_LEVEL = 20

# Бонусы к атаке по уровню героя (кумулятивные)
HERO_LEVEL_ATTACK_BONUS = {
    10: 0.03,   # +3% на уровне 10
    12: 0.03,   # +3% на уровне 12
    16: 0.03,   # +3% на уровне 16
    20: 0.03    # +3% на уровне 20
}

# Значения талантов и навыков
TALENT_VALUES = {
    "untouchable_talent": 0.08,
    "power": 0.045,
    "ice_root": 0.4,
    "ice_flash": 0.35,
    "aroma_aura": 0.1,
    "frost_seal": 0.2,
    "tundra_power": 0.15,
    "frostbound_lotus": 0.25,
    "frost_bloom": 0.45,
    "tessa_f": 1.08,
    "consciousness_match": 1.15  # +15% бонус при совпадении уровня сознания
}
```

## Расчет Атаки

### 1. Формула Базовой Атаки

```
базовая_атака = (BASE_ATTACK + (сознание/10)) * бонус_базовой_атаки
```

Где `бонус_базовой_атаки` рассчитывается как:

```
бонус_базовой_атаки = 1.0 + бонус_уровня_героя + бонусы_талантов + бонус_атаки_нефрита
```

- `бонус_уровня_героя` - Кумулятивный бонус от уровня героя
- `бонусы_талантов` - Сумма активных базовых талантов (untouchable_talent, power)
- `бонус_атаки_нефрита` - Бонус атаки от статов нефрита

### 2. Расчет Бонуса Уровня Героя

```python
def calculate_hero_level_bonus(уровень_героя):
    бонус = 0.0
    for уровень, значение in sorted(HERO_LEVEL_ATTACK_BONUS.items()):
        if уровень_героя >= уровень:
            бонус += значение
    return бонус
```

Например, на уровне героя 20 бонус будет 0.03 + 0.03 + 0.03 + 0.03 = 0.12 (12%).

### 3. Формула Боевой Атаки

```
финальная_атака = (BASE_ATTACK + (сознание/10)) * боевой_бонус_атаки * мультипликатор_тессы * мультипликатор_совпадения_сознания
```

Где:

```
боевой_бонус_атаки = 1.0 + бонус_уровня_героя + базовые_бонусы_талантов + бонус_атаки_нефрита + боевые_бонусы_талантов
```

- `базовые_бонусы_талантов` - Сумма активных базовых талантов (untouchable_talent, power)
- `боевые_бонусы_талантов` - Сумма активных боевых талантов (aroma_aura, frost_seal, tundra_power, frostbound_lotus)
- `мультипликатор_тессы` - 1.08, если "tessa_f" активен, иначе 1.0
- `мультипликатор_совпадения_сознания` - 1.15, если "consciousness_match" активен, иначе 1.0

## Расчет Процента Ледяного Взрыва

### 1. Базовый Процент Ледяного Взрыва

```
базовый_процент_ледяного_взрыва = 1.0 + бонусы_ледяных_талантов + бонус_ледяного_взрыва_нефрита
```

Где `бонусы_ледяных_талантов` - сумма активных ледяных талантов (ice_root, ice_flash).

### 2. Боевой Процент Ледяного Взрыва

```
финальный_процент_ледяного_взрыва = 1.0 + бонусы_ледяных_талантов + бонус_ледяного_взрыва_нефрита + бонус_frost_bloom
```

Где `бонус_frost_bloom` равен 0.45, если "frost_bloom" активен, иначе 0.0.

## Расчеты Урона

### 1. Физический Урон

```
физический_урон = финальная_атака
```

Физический урон просто равен значению финальной атаки.

### 2. Урон Ледяного Взрыва

```
урон_ледяного_взрыва = финальная_атака * финальный_процент_ледяного_взрыва * EXPLOSION_COEF
```

### 3. Урон Взрыва Цветка

```
урон_взрыва_цветка = финальная_атака * финальный_процент_ледяного_взрыва * FLOWER_EXPLOSION_COEF
```

## Расчет Урона Нефрита (3 взрыва)

Последовательность урона нефрита использует специальные мультипликаторы для каждого взрыва:

### 1. Урон Первого Взрыва

```
урон_первого_взрыва = round(финальная_атака * процент_ледяного_взрыва * EXPLOSION_COEF * JADE_FIRST_BLAST_MULTIPLIER)
```

### 2. Урон Второго и Третьего Взрывов

```
урон_второго_взрыва = round(финальная_атака * процент_ледяного_взрыва * EXPLOSION_COEF * JADE_OTHER_BLAST_MULTIPLIER)
урон_третьего_взрыва = урон_второго_взрыва  # Третий взрыв идентичен второму
```

### 3. Общий Урон Нефрита

```
общий_урон_нефрита = урон_первого_взрыва + урон_второго_взрыва + урон_третьего_взрыва
```

## Специализация Урона по Боссам и Монстрам

Приложение рассчитывает специализированный урон по боссам и обычным монстрам:

### 1. Бонус Атаки по Боссам

```
бонус_атаки_по_боссам = бонус_атаки_по_боссам_нефрита  # Из статов нефрита
```

### 2. Процент Ледяного Взрыва по Боссам

```
процент_ледяного_взрыва_по_боссам = (1 * (1 + бонус_атаки_по_боссам)) + (финальный_процент_ледяного_взрыва - 1)
```

### 3. Формулы Урона по Боссам

```
урон_по_боссам = финальная_атака * процент_ледяного_взрыва_по_боссам * EXPLOSION_COEF
урон_взрыва_цветка_по_боссам = финальная_атака * процент_ледяного_взрыва_по_боссам * FLOWER_EXPLOSION_COEF
```

### 4. Бонус Атаки по Монстрам

```
бонус_атаки_по_монстрам = бонус_атаки_по_монстрам_нефрита  # Из статов нефрита
```

### 5. Процент Ледяного Взрыва по Монстрам

```
процент_ледяного_взрыва_по_монстрам = (1 * (1 + бонус_атаки_по_монстрам)) + (финальный_процент_ледяного_взрыва - 1)
```

### 6. Формулы Урона по Монстрам

```
урон_по_монстрам = финальная_атака * процент_ледяного_взрыва_по_монстрам * EXPLOSION_COEF
урон_взрыва_цветка_по_монстрам = финальная_атака * процент_ледяного_взрыва_по_монстрам * FLOWER_EXPLOSION_COEF
```

## Расчет Бонусов Нефрита

Нефриты предоставляют бонусы к статам, влияющие на различные аспекты расчета урона.

### 1. Типы Статов Нефрита

```python
JADE_STAT_TYPES = [
    "Пусто",              # Пустой
    "Атака",              # Атака
    "Лед. взрыв",         # Ледяной взрыв
    "Слияние",            # Слияние
    "Атака по боссу",     # Атака по боссу
    "Атака по монстрам"   # Атака по монстрам
]
```

### 2. Значения Слияния
```python
FUSION_VALUES = ["30", "40", "50"]  # Процентные значения слияния
```

### 3. Расчет Статов Нефрита

Каждый нефрит может иметь до 4 статов. Каждый стат имеет:
- Тип (из JADE_STAT_TYPES)
- Значение (процент в виде строки)
- Состояние активности (всегда true в текущей версии)

### 4. Расчет Эффективных Статов

```python
def get_effective_stats(jade):
    базовые_статы = {}
    общее_слияние = 0.0

    for стат in jade.статы:
        if стат.пустой():
            continue

        тип_стата = стат.тип.получить()
        значение_стата = стат.получить_значение_в_числе() / 100.0  # Преобразование процента в десятичное

        if стат.является_слиянием():
            общее_слияние += стат.получить_множитель_слияния()
        else:
            if тип_стата in базовые_статы:
                базовые_статы[тип_стата] += значение_стата
            else:
                базовые_статы[тип_стата] = значение_стата

    # Применение множителя слияния ко всем статам
    множитель_слияния = 1.0 + общее_слияние
    результат = {}

    for тип_стата, значение in базовые_статы.items():
        результат[тип_стата] = значение * множитель_слияния

    return результат
```

### 5. Расчет Общих Бонусов Нефрита

```python
def calculate_jade_bonuses(jade_configs):
    общие_бонусы = {
        "Атака": 0.0,
        "Лед. взрыв": 0.0,
        "Атака по боссу": 0.0,
        "Атака по монстрам": 0.0
    }
    другие_бонусы = {}

    for нефрит in jade_configs:
        эффективные_статы = нефрит.получить_эффективные_статы()

        for тип_стата, значение in эффективные_статы.items():
            if тип_стата in общие_бонусы:
                общие_бонусы[тип_стата] += значение
            else:
                if тип_стата in другие_бонусы:
                    другие_бонусы[тип_стата] += значение
                else:
                    другие_бонусы[тип_стата] = значение

    # Добавление других бонусов к общим
    общие_бонусы.update(другие_бонусы)

    return общие_бонусы
```

## Полный Поток Расчетов

Вот полный поток расчета урона:

1. **Инициализация Модели** с конфигурациями нефрита
2. **Установка Параметров**:
   - Установка значения сознания
   - Установка уровня героя
   - Установка базовых параметров (untouchable_talent, power, ice_root, ice_flash)
   - Установка боевых параметров (aroma_aura, frost_bloom, frost_seal, tundra_power, frostbound_lotus, tessa_f, consciousness_match)

3. **Расчет Бонусов Нефрита**:
   - Получение бонуса атаки от нефрита
   - Получение бонуса ледяного взрыва от нефрита
   - Получение бонуса атаки по боссам от нефрита
   - Получение бонуса атаки по монстрам от нефрита

4. **Расчет Базовых Параметров**:
   - Расчет бонуса уровня героя
   - Расчет бонуса базовой атаки
   - Расчет базовой атаки
   - Расчет базового процента ледяного взрыва

5. **Расчет Боевых Параметров**:
   - Расчет боевого бонуса атаки
   - Применение мультипликатора tessa_f
   - Применение мультипликатора совпадения сознания
   - Расчет финальной атаки
   - Расчет физического урона
   - Расчет финального процента ледяного взрыва

6. **Расчет Параметров для Боссов**:
   - Установка бонуса атаки по боссам
   - Расчет физического урона по боссам
   - Расчет процента ледяного взрыва по боссам
   - Расчет урона ледяного взрыва по боссам
   - Расчет урона взрыва цветка по боссам

7. **Расчет Параметров для Монстров**:
   - Установка бонуса атаки по монстрам
   - Расчет физического урона по монстрам
   - Расчет процента ледяного взрыва по монстрам
   - Расчет урона ледяного взрыва по монстрам
   - Расчет урона взрыва цветка по монстрам

8. **Расчет Урона Нефрита (3 взрыва)**:
   - Расчет урона первого, второго и третьего взрывов по боссам
   - Расчет общего урона нефрита по боссам
   - Расчет урона первого, второго и третьего взрывов по монстрам
   - Расчет общего урона нефрита по монстрам

9. **Возврат Окончательных Результатов**:
   - Все рассчитанные значения
   - Шаги расчета для подробного вывода

### Пример Последовательности Расчетов

Вот упрощенный пример последовательности расчетов:

```
# Входные данные
сознание = 1200
уровень_героя = 20
untouchable_talent = True  # +8% к атаке
power = True               # +4.5% к атаке
ice_root = True            # +40% к ледяному взрыву
ice_flash = True           # +35% к ледяному взрыву
aroma_aura = True          # +10% к атаке
frost_bloom = True         # +45% к ледяному взрыву
frost_seal = True          # +20% к атаке
tundra_power = True        # +15% к атаке
frostbound_lotus = True    # +25% к атаке
tessa_f = True             # +8% к мультипликатору
consciousness_match = True # +15% к атаке

# Бонусы нефрита (пример)
бонус_атаки_нефрита = 0.25        # +25% к атаке
бонус_ледяного_взрыва_нефрита = 0.30     # +30% к ледяному взрыву
бонус_атаки_по_боссам_нефрита = 0.20   # +20% к атаке против боссов
бонус_атаки_по_монстрам_нефрита = 0.15 # +15% к атаке против монстров

# 1. Расчет бонуса уровня героя
бонус_уровня_героя = 0.03 + 0.03 + 0.03 + 0.03 = 0.12  # +12% на уровне 20

# 2. Расчет бонуса базовой атаки
бонус_базовой_атаки = 1.0 + 0.12 + 0.08 + 0.045 + 0.25 = 1.495  # +49.5%

# 3. Расчет базовой атаки
базовая_атака = (140 + (1200/10)) * 1.495 = (140 + 120) * 1.495 = 388.7

# 4. Расчет базового процента ледяного взрыва
базовый_процент_ледяного_взрыва = 1.0 + 0.4 + 0.35 + 0.3 = 2.05  # 205%

# 5. Расчет боевого бонуса атаки
боевой_бонус_атаки = 1.0 + 0.12 + 0.08 + 0.045 + 0.25 + 0.1 + 0.2 + 0.15 + 0.25 = 2.195  # +119.5%

# 6. Расчет финальной атаки
финальная_атака = (140 + (1200/10)) * 2.195 * 1.08 * 1.15 = 260 * 2.195 * 1.08 * 1.15 = 705.4

# 7. Расчет финального процента ледяного взрыва
финальный_процент_ледяного_взрыва = 1.0 + 0.4 + 0.35 + 0.3 + 0.45 = 2.5  # 250%

# 8. Расчет физического урона
физический_урон = 705.4

# 9. Расчет процента ледяного взрыва по боссам
процент_ледяного_взрыва_по_боссам = (1 + 0.2) + (2.5 - 1) = 1.2 + 1.5 = 2.7  # 270%

# 10. Расчет урона по боссам
урон_по_боссам = 705.4 * 2.7 * 4.06 = 7,719.5

# 11. Расчет урона взрыва цветка по боссам
урон_взрыва_цветка_по_боссам = 705.4 * 2.7 * 4.97 = 9,450.8

# 12. Расчет процента ледяного взрыва по монстрам
процент_ледяного_взрыва_по_монстрам = (1 + 0.15) + (2.5 - 1) = 1.15 + 1.5 = 2.65  # 265%

# 13. Расчет урона по монстрам
урон_по_монстрам = 705.4 * 2.65 * 4.06 = 7,573.5

# 14. Расчет урона взрыва цветка по монстрам
урон_взрыва_цветка_по_монстрам = 705.4 * 2.65 * 4.97 = 9,271.3

# 15. Расчет урона нефрита для боссов
первый_взрыв_нефрита_по_боссам = round(705.4 * 2.7 * 4.06 * 0.55) = round(4,245.7) = 4,246
второй_взрыв_нефрита_по_боссам = round(705.4 * 2.7 * 4.06 * 0.569) = round(4,392.4) = 4,392
третий_взрыв_нефрита_по_боссам = 4,392
общий_урон_нефрита_по_боссам = 4,246 + 4,392 + 4,392 = 13,030

# 16. Расчет урона нефрита для монстров
первый_взрыв_нефрита_по_монстрам = round(705.4 * 2.65 * 4.06 * 0.55) = round(4,165.4) = 4,165
второй_взрыв_нефрита_по_монстрам = round(705.4 * 2.65 * 4.06 * 0.569) = round(4,309.3) = 4,309
третий_взрыв_нефрита_по_монстрам = 4,309
общий_урон_нефрита_по_монстрам = 4,165 + 4,309 + 4,309 = 12,783
```

Этот документ содержит все формулы и логику расчетов, необходимые для полного воссоздания системы расчета урона в другом проекте.
